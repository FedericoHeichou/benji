

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Containerized Benji &mdash; Benji Backup 0.16.1.dev16+g05e02c7 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/asciinema/asciinema-player.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/asciinema/asciinema-player.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Filter Expressions" href="filter_expressions.html" />
    <link rel="prev" title="Administration" href="administration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#fedora-27-and-up">Fedora 27 and up</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#opensuse">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#rhel-centos-7">RHEL/CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ceph-rbd-support">Ceph RBD Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#top-level-configuration-directives">Top-level configuration directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-i-o-configurations">List of I/O Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-transform-configurations">List of Transform Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-storage-configurations">List of Storage Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#i-o-modules">I/O Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-file">I/O Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbd">I/O Module rbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbdaio">I/O Module rbdaio</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-iscsi">I/O Module iscsi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#transform-modules">Transform Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-zstd">Transform Module zstd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm">Transform Module aes_256_gcm</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm-ecc">Transform Module aes_256_gcm_ecc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#storage-modules">Storage Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#hmac">HMAC</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#read-cache">Read Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-file">Storage Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-s3">Storage Module s3</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-b2">Storage Module b2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#nbd">NBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backup.html#simple-backup">Simple Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="backup.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#specifying-a-block-size">Specifying a block size</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#labeling-versions">Labeling <em>Versions</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scrub.html">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#batch-scrubbing">Batch scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-failures">Scrubbing Failures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring">Restoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#restoring-without-a-database">Restoring without a database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#known-issues-with-nbd-client">Known Issues with nbd-client</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring-invalid-versions">Restoring Invalid <em>Versions</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="enforce.html#policy-specification">Policy Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="statistics.html">Storage Statistics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#id1">Storage Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#space-usage-statistics">Space Usage Statistics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-version-metadata">Securing Version Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#backups-and-exports">Backups and Exports</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-block-data-on-storages">Securing Block Data on Storages</a></li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#general-advise">General Advise</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#machine-output">Machine output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Containerized Benji</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#images">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#benji">benji</a></li>
<li class="toctree-l3"><a class="reference internal" href="#benji-k8s">benji-k8s</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#helm-chart">Helm Chart</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="filter_expressions.html">Filter Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#database-backend">Database Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#block-storages">Block Storages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Containerized Benji</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/container.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="containerized-benji">
<span id="container"></span><h1>Containerized Benji<a class="headerlink" href="#containerized-benji" title="Permalink to this headline">¶</a></h1>
<div class="section" id="images">
<h2>Images<a class="headerlink" href="#images" title="Permalink to this headline">¶</a></h2>
<p>The container images are hosted in the GitHub Container Registry:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ghcr.io/elemental-lf/benji:latest</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ghcr.io/elemental-lf/benji-k8s:latest</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">latest</span></code> tag always points to the latest released version. Images for all Git branches of the repository are
available under their branch name, i.e. the current development version is available by referring to the <code class="docutils literal notranslate"><span class="pre">master</span></code> tag.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Older versions of the images are still available on Docker Hub, but no new images will be published there.</p>
</div>
<div class="section" id="benji">
<h3>benji<a class="headerlink" href="#benji" title="Permalink to this headline">¶</a></h3>
<p>The images is based on CentOS 7. Ceph and iSCSI support are present.</p>
<p>The Benji configuration should be put into <code class="docutils literal notranslate"><span class="pre">/etc/benji/benji.yaml</span></code>. Either by inheriting from this image and
overwriting it or by mounting it directly into the container. By default a minimal test configuration is provided
by the image.</p>
<p>The default entry point is just <code class="docutils literal notranslate"><span class="pre">/bin/bash</span></code>.</p>
<p>One use case for this image is for testing Benji:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run --interactive --tty --rm ghcr.io/elemental-lf/benji:latest
</pre></div>
</div>
<p>After that you can directly proceed with step 1 of the instructions in section <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quick Start</span></a>.</p>
</div>
<div class="section" id="benji-k8s">
<h3>benji-k8s<a class="headerlink" href="#benji-k8s" title="Permalink to this headline">¶</a></h3>
<p>This image is directly derived from the <code class="docutils literal notranslate"><span class="pre">benji</span></code> image above. It includes a number of scripts to do backups of
Kubernetes persistent volumes backed by Ceph RBD:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">benji-backup-pvc</span></code> for doing backups</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji-restore-pvc</span></code> for restore operations to either existing or new PVCs/PVs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji-command</span></code> for all other Benji commands</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji-versions-status</span></code> publishes the number of invalid or incomplete versions as Prometheus metrics</p></li>
</ul>
<p>The scripts provide support for volumes provisioned by the classic RBD volume provider, by Rook Ceph CSI and by
Ceph CSI.</p>
<p>Example usages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji-backup-pvc --all-namespaces -l <span class="s1">&#39;release in (prod)&#39;</span>
benji-backup-pvc --namespace staging
benji-command enforce latest3,hours24,days30,months3 <span class="s1">&#39;labels[&quot;benji-backup.me/instance&quot;] == &quot;benji-k8s&quot;&#39;</span>
benji-command cleanup
benji-versions-status
benji-command batch-deep-scrub --version-percentage <span class="m">10</span> --block-percentage <span class="m">33</span> <span class="s1">&#39;labels[&quot;benji-backup.me/instance&quot;] == &quot;benji-k8s&quot;&#39;</span>
</pre></div>
</div>
<p>The backup script <code class="docutils literal notranslate"><span class="pre">benji-backup-pvc</span></code> first searches for <code class="docutils literal notranslate"><span class="pre">PersistemtVolumeClaims</span></code> matching the selector supplied on
the command line. Direct backups of <code class="docutils literal notranslate"><span class="pre">PersistentVolumes</span></code> are currently not supported by this script.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>See <a class="reference external" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors</a>
for possible ways to construct the selector.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">benji-command</span> <span class="pre">enforce</span></code> should be called regularly to expire old backup <em>versions</em>. Also <code class="docutils literal notranslate"><span class="pre">benji-command</span> <span class="pre">cleanup</span></code>
needs to be executed once in a while to actually remove blocks that are no longer used from the storages.</p>
<p>At the end of each command <a class="reference external" href="https://prometheus.io/">Prometheus</a> metrics are pushed to the configured
<a class="reference external" href="https://github.com/prometheus/pushgateway">pushgateway</a>. The format of the variable is <code class="docutils literal notranslate"><span class="pre">host:port</span></code>. If <code class="docutils literal notranslate"><span class="pre">host</span></code>
part is left blank localhost is assumed. If <code class="docutils literal notranslate"><span class="pre">PROM_PUSH_GATEWAY</span></code> is not set, this step is skipped.</p>
<p>The backup script uses Ceph’s differential backup features if possible. Normally only the initial backup is a full
backup. RBD snapshots names are generated with a prefix of <code class="docutils literal notranslate"><span class="pre">b-</span></code>.</p>
</div>
</div>
<div class="section" id="helm-chart">
<h2>Helm Chart<a class="headerlink" href="#helm-chart" title="Permalink to this headline">¶</a></h2>
<p>The Helm chart is the preferred way to deploy the <code class="docutils literal notranslate"><span class="pre">benji-k8s</span></code> image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The deployed resources create a service account which has the right to <em>get</em>,
<em>list</em> and <em>watch</em> all PersistentVolume, PersistentVolumeClaim, Storageclasses and Pod resources in all
namespaces. Additionally it is able to <em>create</em> Events and PersistentVolumeClaims.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="filter_expressions.html" class="btn btn-neutral float-right" title="Filter Expressions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="administration.html" class="btn btn-neutral float-left" title="Administration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2019, Lars Fenneberg, Daniel Kraft.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 


</body>
</html>